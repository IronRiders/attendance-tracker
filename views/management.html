<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap"
        rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management - The Iron Riders - Attendance</title>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>The Iron Riders - Attendance - Management</h1>
            <div class="nav">
                <a href="/management" class="active">Management</a>
                <a href="/reports">Reports</a>
                <a href="/kiosk">Kiosk</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>

        <!-- Add Member Form -->
        <div class="card">
            <h2>Add New Member</h2>
            <div id="add-message" class="status-message hidden"></div>

            <form id="addMemberForm">
                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="barcode">Barcode/ID:</label>
                    <input type="text" id="barcode" name="barcode" required
                        placeholder="Scan barcode or enter manually">
                </div>

                <div class="form-group">
                    <label for="memberType">Member Type:</label>
                    <select id="memberType" name="memberType" required>
                        <option value="Member" selected>Member</option>
                        <option value="Lead">Lead</option>
                        <option value="Executive">Executive</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-success">Add Member</button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
            </form>
        </div>

        <!-- Import Members from CSV -->
        <div class="card">
            <h2>Import Members from CSV</h2>
            <div id="import-message" class="status-message hidden"></div>

            <p style="margin-bottom: 20px; color: #666; font-size: 14px;">
                Upload a CSV file with two columns: Barcode (first column) and Name (second column).
                Existing members with the same barcode will be skipped.
            </p>

            <div class="form-group">
                <label for="csvFile">Select CSV File:</label>
                <input type="file" class="file-input" id="csvFile" accept=".csv" style="margin-bottom: 10px;">
            </div>
            <form>
            <div class="form-group">
                <button type="button" class="btn btn-success" onclick="importCSV()">Import CSV</button>
                <button type="button" class="btn btn-secondary" onclick="clearImport()">Clear</button>
            </div>
            </form>
        </div>

        <!-- Members List -->
        <div class="card">
            <div class="flex justify-between align-center">
                <h2>Current Members</h2>
                <button class="btn btn-secondary" onclick="loadMembers()"
                    style="padding: 12px 24px; font-size: 16px;">Refresh</button>
            </div>

            <div id="loading" class="spinner hidden"></div>

            <div class="table-container">
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Barcode</th>
                            <th>Type</th>
                            <th>Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="membersTableBody">
                        <!-- Members will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Meeting Schedule Management -->
        <div class="card">
            <h2>Meeting Schedules</h2>
            <div id="schedule-message" class="status-message hidden"></div>

            <p style="margin-bottom: 20px; color: #666; font-size: 14px;">
                Configure up to 3 meeting sessions per day. Users can only check in during active session times.
                Automatic logout occurs when each session ends.
            </p>

            <div id="schedule-container">
                <div id="loading-schedules" class="spinner hidden"></div>

                <div class="schedule-days">
                    <div class="schedule-day" data-day="1">
                        <h3>Monday</h3>
                        <div class="sessions">
                            <div class="session" data-session="1">
                                <div class="session-header">
                                    <input type="text" class="session-name-input" name="session_name"
                                        placeholder="Session 1" value="Session 1">
                                </div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="2">
                                <div class="session-header">
                                    <input type="text" class="session-name-input" name="session_name"
                                        placeholder="Session 2" value="Session 2">
                                </div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="3">
                                <div class="session-header">
                                    <input type="text" class="session-name-input" name="session_name"
                                        placeholder="Session 3" value="Session 3">
                                </div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="schedule-day" data-day="2">
                        <h3>Tuesday</h3>
                        <div class="sessions">
                            <div class="session" data-session="1">
                                <div class="session-header">
                                    <input type="text" class="session-name-input" name="session_name"
                                        placeholder="Session 1" value="Session 1">
                                </div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="2">
                                <div class="session-header">
                                    <input type="text" class="session-name-input" name="session_name"
                                        placeholder="Session 2" value="Session 2">
                                </div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="3">
                                <div class="session-header">
                                    <input type="text" class="session-name-input" name="session_name"
                                        placeholder="Session 3" value="Session 3">
                                </div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="schedule-day" data-day="3">
                        <h3>Wednesday</h3>
                        <div class="sessions">
                            <div class="session" data-session="1">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 1" value="Session 1"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="2">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 2" value="Session 2"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="3">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 3" value="Session 3"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="schedule-day" data-day="4">
                        <h3>Thursday</h3>
                        <div class="sessions">
                            <div class="session" data-session="1">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 1" value="Session 1"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="2">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 2" value="Session 2"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="3">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 3" value="Session 3"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="schedule-day" data-day="5">
                        <h3>Friday</h3>
                        <div class="sessions">
                            <div class="session" data-session="1">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 1" value="Session 1"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="2">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 2" value="Session 2"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="3">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 3" value="Session 3"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="schedule-day" data-day="6">
                        <h3>Saturday</h3>
                        <div class="sessions">
                            <div class="session" data-session="1">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 1" value="Session 1"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="2">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 2" value="Session 2"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="3">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 3" value="Session 3"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="schedule-day" data-day="0">
                        <h3>Sunday</h3>
                        <div class="sessions">
                            <div class="session" data-session="1">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 1" value="Session 1"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="2">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 2" value="Session 2"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                            <div class="session" data-session="3">
                                <div class="session-header"><input type="text" class="session-name-input"
                                        name="session_name" placeholder="Session 3" value="Session 3"></div>
                                <div class="time-inputs">
                                    <label>Start: <input type="time" name="start_time" class="session-input"></label>
                                    <label>End: <input type="time" name="end_time" class="session-input"></label>
                                    <button type="button" class="btn-small btn-danger"
                                        onclick="clearSession(this)">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-1" style="margin-top: 20px; justify-content: center;">
                    <button type="button" class="btn btn-success" onclick="saveSchedules()">Save All Schedules</button>
                    <button type="button" class="btn btn-secondary" onclick="loadSchedules()">Reset to Saved</button>
                    <button type="button" class="btn btn-danger" onclick="clearAllSchedules()">Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="card" style="max-width: 500px; width: 90%;">
            <h2>Edit Member</h2>
            <div id="edit-message" class="status-message hidden"></div>

            <form id="editMemberForm">
                <input type="hidden" id="editId" name="id">

                <div class="form-group">
                    <label for="editName">Full Name:</label>
                    <input type="text" id="editName" name="name" required>
                </div>

                <div class="form-group">
                    <label for="editBarcode">Barcode/ID:</label>
                    <input type="text" id="editBarcode" name="barcode" required>
                </div>

                <div class="form-group">
                    <label for="editMemberType">Member Type:</label>
                    <select id="editMemberType" name="memberType" required>
                        <option value="Member">Member</option>
                        <option value="Lead">Lead</option>
                        <option value="Executive">Executive</option>
                    </select>
                </div>

                <div class="flex gap-1">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Results Modal -->
    <div id="importResultsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Import Results</h2>
                <button class="modal-close" onclick="closeImportResultsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="importSummary" class="import-summary">
                    <!-- Import summary will be populated here -->
                </div>

                <div id="skippedSection" class="skipped-section hidden" style="margin-top: 20px;">
                    <h3>Skipped Members:</h3>
                    <div class="table-container">
                        <table id="skippedTable">
                            <thead>
                                <tr>
                                    <th>Barcode</th>
                                    <th>Name</th>
                                    <th>Reason</th>
                                </tr>
                            </thead>
                            <tbody id="skippedTableBody">
                                <!-- Skipped members will be listed here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="errorSection" class="error-section hidden" style="margin-top: 20px;">
                    <h3>Errors:</h3>
                    <div class="error-list">
                        <ul id="errorList">
                            <!-- Errors will be listed here -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeImportResultsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let members = [];

        // Add name field validation
        const barcodeInputElement = document.getElementById('barcode');

        // Validate barcode input to only allow numbers and spaces
        barcodeInputElement.addEventListener('input', (e) => {
            const validValue = e.target.value.replace(/[^0-9\s]/g, '');
            if (e.target.value !== validValue) {
                e.target.value = validValue;
            }

            if (e.target.value.length > 7) {
                e.target.value = e.target.value.substring(0, 7)
            }
        });

        // Prevent invalid keystrokes in barcode field
        barcodeInputElement.addEventListener('keydown', (e) => {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true) ||
                // Allow: home, end, left, right, down, up
                (e.keyCode >= 35 && e.keyCode <= 40)) {
                return; // Let it happen
            }

            // Allow numbers 0-9 (top row) and numpad
            if ((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 96 && e.keyCode <= 105)) {
                return; // Let it happen
            }

            // Block everything else
            e.preventDefault();
        });

        // Function to update session highlighting based on input values
        function updateSessionHighlighting(sessionDiv) {
            const startInput = sessionDiv.querySelector('input[name="start_time"]');
            const endInput = sessionDiv.querySelector('input[name="end_time"]');

            // Don't change styling if session is marked as cleared
            if (sessionDiv.classList.contains('session-cleared')) {
                return;
            }

            // Check if both start and end times are filled
            if (startInput.value && endInput.value) {
                sessionDiv.classList.add('session-active');
            } else {
                sessionDiv.classList.remove('session-active');
            }
        }

        // Function to setup event listeners for all session inputs
        function setupSessionHighlighting() {
            // Get all session divs
            const sessionDivs = document.querySelectorAll('.session');

            sessionDivs.forEach(sessionDiv => {
                const startInput = sessionDiv.querySelector('input[name="start_time"]');
                const endInput = sessionDiv.querySelector('input[name="end_time"]');

                // Add event listeners for input changes
                if (startInput && endInput) {
                    startInput.addEventListener('input', () => updateSessionHighlighting(sessionDiv));
                    endInput.addEventListener('input', () => updateSessionHighlighting(sessionDiv));
                    startInput.addEventListener('change', () => updateSessionHighlighting(sessionDiv));
                    endInput.addEventListener('change', () => updateSessionHighlighting(sessionDiv));

                    // Initial check for existing values
                    updateSessionHighlighting(sessionDiv);
                }
            });
        }

        // Authentication check function
        async function checkAuth() {
            try {
                const response = await fetch('/api/members', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.status === 401) {
                    alert('Your session has expired. Please log in again.');
                    window.location.href = '/login';
                    return false;
                }

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                return false;
            }
        }

        // Periodic authentication check
        function startAuthCheck() {
            // Check authentication every 5 minutes
            setInterval(async () => {
                const isAuthenticated = await checkAuth();
                if (!isAuthenticated) {
                    return; // checkAuth already handles redirect
                }
            }, 5 * 60 * 1000);
        }

        // Enhanced fetch with authentication handling
        async function authenticatedFetch(url, options = {}) {
            options.credentials = 'include';

            const response = await fetch(url, options);

            if (response.status === 401) {
                alert('Your session has expired. Please log in again.');
                window.location.href = '/login';
                throw new Error('Authentication required');
            }

            return response;
        }

        // Load members on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication on page load
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return; // checkAuth handles redirect
            }

            // Start periodic authentication checks
            startAuthCheck();

            loadMembers();
            loadSchedules();

            // Focus on barcode input for easy scanning
            document.getElementById('barcode').focus();

            // Add event listeners for session input changes
            setupSessionHighlighting();
        });

        // Add member form handler
        document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const memberData = Object.fromEntries(formData);
            const messageDiv = document.getElementById('add-message');

            try {
                const response = await authenticatedFetch('/api/members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(memberData)
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(messageDiv, 'Member added successfully!', 'success');
                    document.getElementById('addMemberForm').reset();
                    loadMembers();
                    document.getElementById('barcode').focus();
                } else {
                    showMessage(messageDiv, result.error || 'Failed to add member', 'error');
                }
            } catch (error) {
                showMessage(messageDiv, 'Network error. Please try again.', 'error');
            }
        });

        // Edit member form handler
        document.getElementById('editMemberForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const memberData = Object.fromEntries(formData);
            const id = document.getElementById('editId').value;
            const messageDiv = document.getElementById('edit-message');

            if (!id) {
                showMessage(messageDiv, 'No member ID found. Please try again.', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/members/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(memberData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`Server error: ${response.status} - ${error}`);
                }

                const result = await response.json();

                if (result.success) {
                    closeEditModal();
                    loadMembers();
                } else {
                    showMessage(messageDiv, result.error || 'Failed to update member', 'error');
                }
            } catch (error) {
                console.error('Edit member error:', error);
                showMessage(messageDiv, `Network error: ${error.message}`, 'error');
            }
        });

        // Meeting Schedule Management Functions
        async function loadSchedules() {
            const loadingDiv = document.getElementById('loading-schedules');
            if (loadingDiv) loadingDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/meeting-schedules');
                const schedules = await response.json();

                // Clear all existing schedule inputs
                clearAllScheduleInputs();

                // Populate schedule inputs with loaded data
                schedules.forEach(schedule => {
                    const dayDiv = document.querySelector(`.schedule-day[data-day="${schedule.day_of_week}"]`);
                    if (dayDiv) {
                        const sessionDiv = dayDiv.querySelector(`.session[data-session="${schedule.session_number}"]`);
                        if (sessionDiv) {
                            const startInput = sessionDiv.querySelector('input[name="start_time"]');
                            const endInput = sessionDiv.querySelector('input[name="end_time"]');
                            const nameInput = sessionDiv.querySelector('input[name="session_name"]');

                            if (startInput) startInput.value = schedule.start_time || '';
                            if (endInput) endInput.value = schedule.end_time || '';
                            if (nameInput) nameInput.value = schedule.session_name || `Session ${schedule.session_number}`;

                            // Update highlighting for this session
                            updateSessionHighlighting(sessionDiv);
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading schedules:', error);
                showMessage(document.getElementById('schedule-message'),
                    'Failed to load schedules', 'error');
            }

            if (loadingDiv) loadingDiv.classList.add('hidden');
        }

        function clearAllScheduleInputs() {
            const allInputs = document.querySelectorAll('.session-input, .session-name-input');
            const allSessions = document.querySelectorAll('.session');

            allInputs.forEach(input => {
                if (input.name === 'session_name') {
                    // Reset to default session name
                    const sessionDiv = input.closest('.session');
                    const sessionNumber = sessionDiv.getAttribute('data-session');
                    input.value = `Session ${sessionNumber}`;
                } else {
                    input.value = '';
                }
            });

            // Remove all highlighting classes
            allSessions.forEach(sessionDiv => {
                sessionDiv.classList.remove('session-active', 'session-cleared');
                // Clear any stored original data
                delete sessionDiv.dataset.originalStart;
                delete sessionDiv.dataset.originalEnd;
                delete sessionDiv.dataset.originalName;
            });
        }

        async function saveSchedules() {
            console.log('saveSchedules function called');
            const schedules = [];
            const messageDiv = document.getElementById('schedule-message');
            let hasErrors = false;

            // Collect all schedule data and validate
            document.querySelectorAll('.schedule-day').forEach(dayDiv => {
                const dayOfWeek = parseInt(dayDiv.getAttribute('data-day'));
                console.log('Processing day:', dayOfWeek);

                dayDiv.querySelectorAll('.session').forEach(sessionDiv => {
                    const sessionNumber = parseInt(sessionDiv.getAttribute('data-session'));
                    const startTime = sessionDiv.querySelector('input[name="start_time"]').value;
                    const endTime = sessionDiv.querySelector('input[name="end_time"]').value;
                    const sessionName = sessionDiv.querySelector('input[name="session_name"]').value || `Session ${sessionNumber}`;

                    console.log(`Day ${dayOfWeek}, Session ${sessionNumber}: ${startTime} - ${endTime} (${sessionName})`);

                    // Only add sessions that have both start and end times
                    if (startTime && endTime) {
                        // Validate that start time is before end time
                        if (startTime >= endTime) {
                            console.error('Time validation error:', dayOfWeek, sessionNumber, startTime, endTime);
                            showMessage(messageDiv,
                                `Error: Start time must be before end time for ${getDayName(dayOfWeek)} ${sessionName}`, 'error');
                            hasErrors = true;
                            return;
                        }

                        schedules.push({
                            dayOfWeek: dayOfWeek,
                            sessionNumber: sessionNumber,
                            startTime: startTime,
                            endTime: endTime,
                            sessionName: sessionName
                        });
                    }
                });
            });

            console.log('Collected schedules:', schedules);
            console.log('Has errors:', hasErrors);

            // Stop if there are validation errors
            if (hasErrors) {
                console.log('Stopping due to validation errors');
                return;
            }

            console.log('Making API request with schedules:', schedules);
            try {
                const response = await fetch('/api/meeting-schedules', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ schedules })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const error = await response.text();
                    console.error('Server error response:', error);
                    throw new Error(`Server error: ${response.status} - ${error}`);
                }

                const result = await response.json();
                console.log('Server response:', result);

                if (result.success) {
                    showMessage(messageDiv, result.message || 'Schedules updated successfully!', 'success');

                    // Clear visual indicators and stored data for cleared sessions
                    document.querySelectorAll('.session-cleared').forEach(sessionDiv => {
                        sessionDiv.classList.remove('session-cleared');
                        delete sessionDiv.dataset.originalStart;
                        delete sessionDiv.dataset.originalEnd;
                        delete sessionDiv.dataset.originalName;
                    });

                    // Note: Meeting scheduler is already refreshed server-side
                    console.log('Schedules saved and meeting scheduler refreshed server-side');
                } else {
                    showMessage(messageDiv, result.error || 'Failed to update schedules', 'error');
                }

            } catch (error) {
                console.error('Error saving schedules:', error);
                showMessage(messageDiv, 'Network error. Please try again.', 'error');
            }
        }

        function clearSession(button) {
            const sessionDiv = button.closest('.session');
            const startInput = sessionDiv.querySelector('input[name="start_time"]');
            const endInput = sessionDiv.querySelector('input[name="end_time"]');
            const nameInput = sessionDiv.querySelector('input[name="session_name"]');
            const sessionNumber = sessionDiv.getAttribute('data-session');

            // Check if this session has any times set
            if (!startInput.value && !endInput.value) {
                // Session is already empty, just reset the name
                nameInput.value = `Session ${sessionNumber}`;
                return;
            }

            // Store original values for potential undo
            sessionDiv.dataset.originalStart = startInput.value;
            sessionDiv.dataset.originalEnd = endInput.value;
            sessionDiv.dataset.originalName = nameInput.value;

            // Clear the form inputs locally
            startInput.value = '';
            endInput.value = '';
            nameInput.value = `Session ${sessionNumber}`;

            // Add visual indication that this session was cleared (will be deleted on save)
            sessionDiv.classList.add('session-cleared');

            // Show message that changes are pending
            const messageDiv = document.getElementById('schedule-message');
            showMessage(messageDiv, 'Session cleared locally. Click "Save All Schedules" to apply changes, or refresh page to undo.', 'warning');
        }

        function undoClearSession(sessionDiv) {
            // Restore original values
            const startInput = sessionDiv.querySelector('input[name="start_time"]');
            const endInput = sessionDiv.querySelector('input[name="end_time"]');
            const nameInput = sessionDiv.querySelector('input[name="session_name"]');

            if (sessionDiv.dataset.originalStart) {
                startInput.value = sessionDiv.dataset.originalStart;
                endInput.value = sessionDiv.dataset.originalEnd;
                nameInput.value = sessionDiv.dataset.originalName;

                // Remove visual indication
                sessionDiv.classList.remove('session-cleared');

                // Clear stored data
                delete sessionDiv.dataset.originalStart;
                delete sessionDiv.dataset.originalEnd;
                delete sessionDiv.dataset.originalName;

                // Show undo message
                const messageDiv = document.getElementById('schedule-message');
                showMessage(messageDiv, 'Session restore undone.', 'info');
            }
        }

        async function deleteSession(dayOfWeek, sessionNumber) {
            const response = await fetch(`/api/meeting-schedules/${dayOfWeek}/${sessionNumber}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Server error: ${response.status} - ${error}`);
            }

            return response.json();
        }

        function clearAllSchedules() {
            if (confirm('Are you sure you want to clear all meeting schedules? This will remove all session times.')) {
                clearAllScheduleInputs();
            }
        }

        function getDayName(dayOfWeek) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[dayOfWeek] || 'Unknown';
        }

        async function loadMembers() {
            const loading = document.getElementById('loading');
            const tbody = document.getElementById('membersTableBody');

            loading.classList.remove('hidden');

            try {
                const response = await authenticatedFetch('/api/members');
                members = await response.json();

                tbody.innerHTML = '';

                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No members found</td></tr>';
                } else {
                    members.forEach(member => {
                        const row = document.createElement('tr');
                        const memberType = member.member_type || 'Member';
                        var typeClass;
                        
                        if (memberType === 'Executive') {
                            typeClass = 'executive-badge'
                        } else if (memberType === 'Lead') {
                            typeClass = 'lead-badge'
                        } else {
                            typeClass = 'member-badge';
                        }

                        row.innerHTML = `
                            <td>${member.name}</td>
                            <td>${member.barcode}</td>
                            <td><span class="${typeClass}">${memberType}</span></td>
                            <td>${new Date(member.created_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editMember(${member.id})" 
                                        style="margin-right: 5px; padding: 12px 24px; font-size: 16px;">Edit</button>
                                <button class="btn btn-danger" onclick="deleteMember(${member.id}, '${member.name}')"
                                        style="padding: 12px 24px; font-size: 16px;">Delete</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Error loading members: ' + error + '</td></tr>';
            }

            loading.classList.add('hidden');
        }

        function editMember(id) {
            const member = members.find(m => m.id === id);
            if (member) {
                document.getElementById('editId').value = member.id;
                document.getElementById('editName').value = member.name;
                document.getElementById('editBarcode').value = member.barcode;
                document.getElementById('editMemberType').value = member.member_type || 'Member';
                document.getElementById('editModal').classList.remove('hidden');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('edit-message').classList.add('hidden');
        }

        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('editModal')) {
                closeEditModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('editModal');
                if (!modal.classList.contains('hidden')) {
                    closeEditModal();
                }
            }
        });

        async function deleteMember(id, name) {
            if (confirm(`Are you sure you want to delete ${name}? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/members/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        loadMembers();
                        showMessage(document.getElementById('add-message'), 'Member deleted successfully', 'success');
                    } else {
                        alert('Failed to delete member');
                    }
                } catch (error) {
                    alert('Network error. Please try again.');
                }
            }
        }

        function clearForm() {
            document.getElementById('addMemberForm').reset();
            document.getElementById('add-message').classList.add('hidden');
            document.getElementById('barcode').focus();
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = `status-message status-${type}`;
            element.classList.remove('hidden');

            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        async function logout() {
            try {
                const response = await fetch('/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Handle barcode scanner input
        let barcodeInput = '';
        let barcodeTimeout;

        document.addEventListener('keypress', (e) => {
            const activeElement = document.activeElement;

            // Only capture barcode when focused on barcode input fields
            if (activeElement && (activeElement.id === 'barcode' || activeElement.id === 'editBarcode')) {
                clearTimeout(barcodeTimeout);

                if (e.key === 'Enter') {
                    // Barcode scanners typically send Enter after the code
                    if (barcodeInputElement.length > 0) {
                        activeElement.value = barcodeInputElement;
                        barcodeInputElement = '';
                    }
                } else {
                    barcodeInputElement += e.key;

                    // Reset after 100ms of inactivity
                    barcodeTimeout = setTimeout(() => {
                        barcodeInputElement = '';
                    }, 100);
                }
            }
        });

        // CSV Import Functions
        async function importCSV() {
            const fileInput = document.getElementById('csvFile');
            const messageElement = document.getElementById('import-message');

            if (!fileInput.files.length) {
                showMessage(messageElement, 'Please select a CSV file first.', 'error');
                return;
            }

            const file = fileInput.files[0];

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage(messageElement, 'Please select a valid CSV file.', 'error');
                return;
            }

            try {
                const csvText = await readFileAsText(file);
                const parsedData = parseCSV(csvText);

                if (parsedData.length === 0) {
                    showMessage(messageElement, 'The CSV file appears to be empty.', 'error');
                    return;
                }

                // Send to server for processing
                const response = await fetch('/api/members/import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ members: parsedData })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Show detailed results in modal popup
                    showImportResultsModal(result);
                    loadMembers(); // Refresh the members list
                    clearImport();
                } else {
                    showMessage(messageElement,
                        result.error || 'Error importing members. Please try again.',
                        'error');
                }

            } catch (error) {
                console.error('Error importing CSV:', error);
                showMessage(messageElement, 'Error processing CSV file. Please check the format.', 'error');
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const members = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Simple CSV parsing - split by comma and handle basic quoted fields
                const columns = line.split(',').map(col => col.trim().replace(/^["']|["']$/g, ''));

                if (columns.length >= 2) {
                    const barcode = columns[0].trim();
                    const name = columns[1].trim();

                    if (barcode && name) {
                        members.push({ barcode, name });
                    }
                }
            }

            return members;
        }

        function clearImport() {
            document.getElementById('csvFile').value = '';
            document.getElementById('import-message').classList.add('hidden');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Import Results Modal Functions
        function showImportResultsModal(result) {
            const modal = document.getElementById('importResultsModal');
            const summaryDiv = document.getElementById('importSummary');
            const skippedSection = document.getElementById('skippedSection');
            const errorSection = document.getElementById('errorSection');
            const skippedTableBody = document.getElementById('skippedTableBody');
            const errorList = document.getElementById('errorList');

            // Build summary message
            let summaryHtml = `<div class="import-summary-success">
                <h3> Import Complete!</h3>
                <p><strong>${result.imported}</strong> members successfully imported</p>`;

            if (result.skipped > 0) {
                summaryHtml += `<p><strong>${result.skipped}</strong> members skipped (duplicates or errors)</p>`;
            }

            summaryHtml += `</div>`;
            summaryDiv.innerHTML = summaryHtml;

            // Show skipped members if any
            if (result.skippedMembers && result.skippedMembers.length > 0) {
                skippedTableBody.innerHTML = result.skippedMembers.map(member =>
                    `<tr>
                        <td>${escapeHtml(member.barcode || '')}</td>
                        <td>${escapeHtml(member.name || '')}</td>
                        <td>${escapeHtml(member.reason || 'Duplicate barcode')}</td>
                    </tr>`
                ).join('');
                skippedSection.classList.remove('hidden');
            } else {
                skippedSection.classList.add('hidden');
            }

            // Show errors if any
            if (result.errors && result.errors.length > 0) {
                errorList.innerHTML = result.errors.map(error =>
                    `<li>${escapeHtml(error)}</li>`
                ).join('');
                errorSection.classList.remove('hidden');
            } else {
                errorSection.classList.add('hidden');
            }

            // Show the modal
            modal.classList.remove('hidden');
        }

        function closeImportResultsModal() {
            document.getElementById('importResultsModal').classList.add('hidden');
        }

        // Close modal when clicking outside of it
        document.addEventListener('click', function (event) {
            const modal = document.getElementById('importResultsModal');
            if (event.target === modal) {
                closeImportResultsModal();
            }
        });
    </script>
</body>

</html>