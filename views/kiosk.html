<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk - ChainLynx Attendance</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="kiosk-container">
        <div class="kiosk-card">
            <h1 style="color: #9A061C; margin-bottom: 2rem;">ChainLynx Attendance</h1>
            
            <div id="status-display" class="status-message status-info">
                <strong>Ready to scan</strong><br>
                Please scan your barcode or enter your ID
            </div>
            
            <div class="form-group">
                <input type="text" 
                       id="barcodeInput" 
                       class="kiosk-input" 
                       placeholder="Scan barcode here..."
                       autocomplete="off"
                       pattern="[0-9]*"
                       inputmode="numeric"
                       autofocus>
            </div>
            
            <!-- Manual entry option -->
            <div id="manualEntry" class="hidden">
                <p style="margin: 1rem 0; color: #666;">
                    Can't scan? <a href="#" onclick="toggleManualEntry()" style="color: #9A061C;">Enter manually</a>
                </p>
            </div>
            
            <!-- Member info display -->
            <div id="memberInfo" class="hidden" style="margin-top: 2rem;">
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                    <h3 id="memberName" style="margin-bottom: 0.5rem; color: #333;"></h3>
                    <p id="memberDetails" style="color: #666; margin: 0;"></p>
                </div>
            </div>
            
            <!-- Action feedback -->
            <div id="actionFeedback" class="hidden" style="margin-top: 1rem;">
                <div style="font-size: 1.2rem; font-weight: bold; padding: 1rem;">
                    <div id="actionText"></div>
                    <div id="actionTime" style="font-size: 1rem; color: #666; margin-top: 0.5rem;"></div>
                </div>
            </div>
            
            <!-- Currently checked in -->
            <div id="recentActivity" class="hidden" style="margin-top: 2rem;">
                <h4 style="color: #333; margin-bottom: 1rem;">Currently Checked In</h4>
                <div id="activityList" style="max-height: 200px; overflow-y: auto;">
                    <!-- Currently checked in members will be displayed here -->
                </div>
            </div>
            
            <!-- Admin access -->
            <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #eee;">
                <small style="color: #999;">
                    <a href="/login" style="color: #9A061C; text-decoration: none;">Admin Access</a> | 
                    <span id="datetime"></span>
                </small>
            </div>
        </div>
    </div>

    <!-- Sign Up Modal -->
    <div id="signupModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Member Sign Up</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: #666;">
                    This ID is not registered. Please enter your name to sign up:
                </p>
                <div class="form-group">
                    <label for="signupName">Full Name:</label>
                    <input type="text" 
                           id="signupName" 
                           class="kiosk-input" 
                           placeholder="Enter your full name"
                           autocomplete="off"
                           pattern="[A-Za-z\s]*"
                           title="Only English letters and spaces are allowed"
                           maxlength="100">
                </div>
                <div class="form-group">
                    <label for="signupBarcode">Your ID:</label>
                    <input type="text" 
                           id="signupBarcode" 
                           class="kiosk-input" 
                           readonly
                           tabindex="-1"
                           style="background-color: #f8f9fa; pointer-events: none; user-select: none;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSignupModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitSignup()">Sign Up & Check In</button>
            </div>
        </div>
    </div>

    <script>
        let scanTimeout;
        let barcodeBuffer = '';
        let recentScans = [];
        let isProcessing = false;
        let recentBarcodeScans = new Map(); // Track recent scans for debounce

        // Utility function to parse UTC timestamps from database
        function parseTimestamp(timestampStr) {
            // Database timestamps are now stored in the configured timezone
            // Parse as local timezone timestamp (no 'Z' suffix)
            const isoString = timestampStr.replace(' ', 'T');
            return new Date(isoString);
        }

        // Convert 24-hour time string to 12-hour format
        function formatTime12Hour(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours === 0 ? 12 : hours > 12 ? hours - 12 : hours;
            return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        }

        // Debounce function to prevent double scans within 30 seconds
        function isRecentScan(barcode) {
            const now = Date.now();
            const lastScanTime = recentBarcodeScans.get(barcode);
            
            if (lastScanTime && (now - lastScanTime) < 30000) { // 30 seconds = 30000ms
                return true;
            }
            
            return false;
        }

        // Record a scan for debounce tracking
        function recordScan(barcode) {
            const now = Date.now();
            recentBarcodeScans.set(barcode, now);
            
            // Clean up old entries (older than 30 seconds)
            for (const [key, value] of recentBarcodeScans.entries()) {
                if (now - value > 30000) {
                    recentBarcodeScans.delete(key);
                }
            }
        }

        // Initialize kiosk
        document.addEventListener('DOMContentLoaded', () => {
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second
            loadCurrentlyCheckedIn();
            checkMeetingSchedule(); // Check current meeting schedule status
            
            // Refresh checked-in list every 30 seconds
            setInterval(loadCurrentlyCheckedIn, 30000);
            
            // Update durations every minute
            setInterval(updateActivityDisplay, 60000);
            
            // Check meeting schedule every minute
            setInterval(checkMeetingSchedule, 60000);
            
            // Focus on input
            document.getElementById('barcodeInput').focus();
            
            // Add name field validation
            const nameInput = document.getElementById('signupName');
            
            // Validate name input to only allow English letters and spaces
            nameInput.addEventListener('input', (e) => {
                // Remove any characters that aren't letters or spaces
                const validValue = e.target.value.replace(/[^A-Za-z\s]/g, '');
                if (e.target.value !== validValue) {
                    e.target.value = validValue;
                }
            });

            // Prevent invalid keystrokes in name field
            nameInput.addEventListener('keydown', (e) => {
                // Allow: backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    // Allow: home, end, left, right, down, up
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                    return; // Let it happen
                }
                
                // Allow letters (A-Z, a-z)
                if ((e.keyCode >= 65 && e.keyCode <= 90)) {
                    return; // Let it happen
                }
                
                // Allow only space (32)
                if (e.keyCode === 32) {
                    return; // Let it happen
                }
                
                // Block everything else
                e.preventDefault();
            });
        });

        // Validate barcode input to only allow numbers
        document.getElementById('barcodeInput').addEventListener('input', (e) => {
            // Remove any non-numeric characters
            const numericValue = e.target.value.replace(/[^0-9]/g, '');
            if (e.target.value !== numericValue) {
                e.target.value = numericValue;
            }
        });

        // Prevent non-numeric keystrokes in real-time
        document.getElementById('barcodeInput').addEventListener('keydown', (e) => {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true) ||
                // Allow: home, end, left, right, down, up
                (e.keyCode >= 35 && e.keyCode <= 40)) {
                return; // Let it happen, don't do anything
            }
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });

        // Handle barcode input
        document.getElementById('barcodeInput').addEventListener('input', (e) => {
            const barcode = e.target.value.trim();
            
            // Clear previous timeout
            clearTimeout(scanTimeout);
            
            if (barcode.length > 0) {
                // Set timeout to process barcode after a short delay
                scanTimeout = setTimeout(() => {
                    processBarcode(barcode);
                }, 300);
            }
        });

        // Handle Enter key press
        document.getElementById('barcodeInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(scanTimeout);
                const barcode = e.target.value.trim();
                if (barcode) {
                    processBarcode(barcode);
                }
            }
        });

        // Also handle fast barcode scanner input
        document.addEventListener('keypress', (e) => {
            const input = document.getElementById('barcodeInput');
            
            // Only capture if input is focused or if no other element has focus
            if (document.activeElement === input || document.activeElement === document.body) {
                // Focus input if not already focused
                if (document.activeElement !== input) {
                    input.focus();
                }
                
                clearTimeout(scanTimeout);
                
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (barcodeBuffer.length > 0) {
                        input.value = barcodeBuffer;
                        processBarcode(barcodeBuffer);
                        barcodeBuffer = '';
                    }
                } else if (e.key.length === 1) { // Regular character
                    barcodeBuffer += e.key;
                    
                    // Reset buffer after 100ms of inactivity
                    scanTimeout = setTimeout(() => {
                        barcodeBuffer = '';
                    }, 100);
                }
            }
        });

        async function checkMeetingSchedule() {
            try {
                const response = await fetch('/api/meeting-schedules/current');
                const scheduleInfo = await response.json();
                
                const statusDisplay = document.getElementById('status-display');
                const input = document.getElementById('barcodeInput');
                
                if (scheduleInfo.active) {
                    // Within active meeting session
                    const session = scheduleInfo.session;
                    const endTime12 = formatTime12Hour(session.end_time);
                    showStatus(`Meeting Session ${session.session_number} Active<br>Sign-ins allowed until ${endTime12}`, 'success');
                    input.disabled = false;
                    input.placeholder = 'Scan barcode here...';
                } else {
                    // Outside meeting hours
                    let message = 'Outside meeting hours<br>Sign-ins not allowed';
                    
                    if (scheduleInfo.nextSession) {
                        const next = scheduleInfo.nextSession;
                        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        const dayName = dayNames[next.day];
                        const startTime12 = formatTime12Hour(next.start);
                        const endTime12 = formatTime12Hour(next.end);
                        const sessionName = next.session_name || `Session ${next.session}`;
                        message = `Outside meeting hours<br>${sessionName}: ${dayName} ${startTime12}-${endTime12}`;
                    }
                    
                    showStatus(message, 'warning');
                    input.disabled = true;
                    input.placeholder = 'Sign-ins not allowed outside meeting hours';
                }
            } catch (error) {
                console.error('Error checking meeting schedule:', error);
                // Fallback - allow sign-ins if can't check schedule
                const input = document.getElementById('barcodeInput');
                input.disabled = false;
                showStatus('Ready to scan<br>Please scan your barcode or enter your ID', 'info');
            }
        }

        async function processBarcode(barcode) {
            if (isProcessing) return;
            
            // Check for recent scan debounce
            if (isRecentScan(barcode)) {
                const statusDisplay = document.getElementById('status-display');
                const input = document.getElementById('barcodeInput');
                
                showStatus('Please wait 30 seconds between scans', 'warning');
                
                // Auto-clear warning after 3 seconds
                setTimeout(() => {
                    showStatus('Ready to scan<br>Please scan your barcode or enter your ID', 'info');
                }, 3000);
                
                // Clear input and return
                input.value = '';
                input.focus();
                return;
            }
            
            isProcessing = true;
            const statusDisplay = document.getElementById('status-display');
            const memberInfo = document.getElementById('memberInfo');
            const actionFeedback = document.getElementById('actionFeedback');
            const input = document.getElementById('barcodeInput');
            
            // Show processing state
            showStatus('Processing...', 'info');
            
            try {
                const response = await fetch('/api/attendance/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ barcode })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Record this scan for debounce tracking
                    recordScan(barcode);
                    
                    // Show member info
                    document.getElementById('memberName').textContent = result.member.name;
                    document.getElementById('memberDetails').textContent = 
                        `ID: ${result.member.barcode}`;
                    memberInfo.classList.remove('hidden');
                    
                    // Show action feedback
                    const actionText = result.action === 'check-in' ? 'CHECKED IN' : 'CHECKED OUT';
                    const actionColor = result.action === 'check-in' ? '#28a745' : '#dc3545';
                    
                    document.getElementById('actionText').textContent = actionText;
                    document.getElementById('actionText').style.color = actionColor;
                    document.getElementById('actionTime').textContent = 
                        new Date(result.timestamp).toLocaleTimeString();
                    actionFeedback.classList.remove('hidden');
                    
                    // Show success status
                    showStatus(`Welcome, ${result.member.name}!`, 'success');
                    
                    // Refresh currently checked-in list
                    loadCurrentlyCheckedIn();
                    
                    // Auto-clear after 5 seconds
                    setTimeout(() => {
                        clearDisplay();
                    }, 5000);
                    
                } else {
                    // Check if this is a "Member not found" error (404)
                    if (response.status === 404 && result.error && result.error.includes('Member not found')) {
                        // Show signup modal for unknown barcode
                        showSignupModal(barcode);
                    } else {
                        showStatus(result.error || 'Scan failed', 'error');
                        
                        // Auto-clear error after 3 seconds
                        setTimeout(() => {
                            showStatus('Ready to scan', 'info');
                        }, 3000);
                    }
                }
                
            } catch (error) {
                console.error('Scan error:', error);
                showStatus('Network error. Please try again.', 'error');
                
                // Auto-clear error after 3 seconds
                setTimeout(() => {
                    showStatus('Ready to scan', 'info');
                }, 3000);
            }
            
            // Clear input and reset
            input.value = '';
            input.focus();
            isProcessing = false;
        }

        function showStatus(message, type) {
            const statusDisplay = document.getElementById('status-display');
            statusDisplay.innerHTML = `<strong>${message}</strong>`;
            statusDisplay.className = `status-message status-${type}`;
        }

        function clearDisplay() {
            document.getElementById('memberInfo').classList.add('hidden');
            document.getElementById('actionFeedback').classList.add('hidden');
            showStatus('Ready to scan<br>Please scan your barcode or enter your ID', 'info');
            document.getElementById('barcodeInput').focus();
        }

        function updateActivityDisplay() {
            const activityList = document.getElementById('activityList');
            const recentActivity = document.getElementById('recentActivity');
            
            recentActivity.classList.remove('hidden');
            
            if (recentScans.length === 0) {
                activityList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                        No one is currently checked in
                    </div>
                `;
                return;
            }
            
            activityList.innerHTML = '';
            recentScans.forEach(scan => {
                const item = document.createElement('div');
                item.style.cssText = `
                    display: flex; 
                    justify-content: space-between; 
                    align-items: center;
                    padding: 8px; 
                    margin-bottom: 4px; 
                    background: #f8f9fa; 
                    border-radius: 4px;
                `;
                
                const actionColor = scan.action === 'checked-in' ? '#28a745' : '#dc3545';
                const actionText = scan.action === 'checked-in' ? '' : 'OUT';
                
                // Calculate duration since check-in
                const now = new Date();
                const checkinTime = scan.timestamp;
                const diffMs = now - checkinTime;
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMinutes / 60);
                const remainingMinutes = diffMinutes % 60;
                
                console.log('Duration calc for', scan.name + ':', {
                    now: now.toString(),
                    checkinTime: checkinTime.toString(),
                    diffMs: diffMs,
                    diffMinutes: diffMinutes,
                    diffHours: diffHours,
                    remainingMinutes: remainingMinutes
                });
                
                let durationText;
                if (diffMinutes < 0) {
                    // Handle negative time (timezone issue)
                    console.log('Negative duration detected for', scan.name);
                    durationText = 'just now';
                } else if (diffMinutes < 1) {
                    console.log('Less than 1 minute for', scan.name);
                    durationText = 'just now';
                } else if (diffHours > 0) {
                    durationText = `${diffHours}h ${remainingMinutes}m`;
                } else {
                    durationText = `${diffMinutes}m`;
                }
                
                console.log('Final duration text:', durationText);
                
                item.innerHTML = `
                    <span style="font-weight: 500;">${scan.name}</span>
                    <div>
                        <span style="color: ${actionColor}; font-weight: bold; font-size: 0.9rem;">${actionText}</span>
                        <span style="color: #666; font-size: 0.8rem; margin-left: 8px;">
                            ${durationText}
                        </span>
                    </div>
                `;
                
                activityList.appendChild(item);
            });
        }

        async function loadCurrentlyCheckedIn() {
            try {
                console.log('Loading currently checked-in members...');
                const response = await fetch('/api/currently-checked-in');
                const checkedInMembers = await response.json();
                console.log('Checked-in members:', checkedInMembers);
                
                // Clear previous list
                recentScans = [];
                
                // Convert to display format
                checkedInMembers.forEach(member => {
                    // Database format: '2025-09-21 20:36:43' stored as UTC
                    const timestampStr = member.last_checkin;
                    console.log('Original timestamp:', timestampStr);
                    
                    // Parse the timestamp properly
                    const dbTimestamp = parseTimestamp(timestampStr);
                    
                    console.log('Parsed as UTC, displayed in local time:', dbTimestamp);
                    console.log('Current time:', new Date());
                    
                    recentScans.push({
                        name: member.name,
                        action: 'checked-in',
                        timestamp: dbTimestamp
                    });
                });
                
                console.log('Recent scans:', recentScans);
                updateActivityDisplay();
                
            } catch (error) {
                console.error('Error loading currently checked-in members:', error);
            }
        }

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('en-US', options);
        }

        function toggleManualEntry() {
            const input = document.getElementById('barcodeInput');
            input.placeholder = 'Enter your ID manually...';
            input.focus();
        }

        // Prevent form submission
        document.addEventListener('submit', (e) => {
            e.preventDefault();
        });

        // Keep focus on input when clicking elsewhere
        document.addEventListener('click', (e) => {
            // Don't refocus if clicking on a link
            if (e.target.tagName !== 'A') {
                // Don't refocus if signup modal is open
                const signupModal = document.getElementById('signupModal');
                if (signupModal && !signupModal.classList.contains('hidden')) {
                    return;
                }
                
                setTimeout(() => {
                    document.getElementById('barcodeInput').focus();
                }, 100);
            }
        });

        // Signup Modal Functions
        function showSignupModal(barcode) {
            const modal = document.getElementById('signupModal');
            const barcodeInput = document.getElementById('signupBarcode');
            const nameInput = document.getElementById('signupName');
            
            // Set the barcode in the readonly field
            barcodeInput.value = barcode;
            
            // Clear and focus on name input
            nameInput.value = '';
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Focus on name input after modal is shown
            setTimeout(() => {
                nameInput.focus();
            }, 100);
        }

        function closeSignupModal() {
            const modal = document.getElementById('signupModal');
            const nameInput = document.getElementById('signupName');
            const barcodeInput = document.getElementById('signupBarcode');
            
            // Hide modal
            modal.classList.add('hidden');
            
            // Clear inputs
            nameInput.value = '';
            barcodeInput.value = '';
            
            // Reset main interface
            const mainInput = document.getElementById('barcodeInput');
            mainInput.value = '';
            mainInput.focus();
            isProcessing = false;
            
            showStatus('Ready to scan<br>Please scan your barcode or enter your ID', 'info');
        }

        async function submitSignup() {
            const nameInput = document.getElementById('signupName');
            const barcodeInput = document.getElementById('signupBarcode');
            const name = nameInput.value.trim();
            const barcode = barcodeInput.value.trim();
            
            // Validate inputs
            if (!name) {
                alert('Please enter your full name.');
                nameInput.focus();
                return;
            }
            
            if (name.length < 2) {
                alert('Please enter a valid name (at least 2 characters).');
                nameInput.focus();
                return;
            }
            
            try {
                // Disable button during submission
                const submitBtn = document.querySelector('.btn-primary');
                const cancelBtn = document.querySelector('.btn-secondary');
                submitBtn.disabled = true;
                cancelBtn.disabled = true;
                submitBtn.textContent = 'Signing Up...';
                
                // Create new member
                const response = await fetch('/api/kiosk/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        name: name,
                        barcode: barcode 
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Close modal
                    closeSignupModal();
                    
                    // Show success message
                    showStatus(`Welcome ${name}!<br>Account created successfully! Processing check-in...`, 'success');
                    
                    // Wait a moment then process the barcode scan
                    setTimeout(() => {
                        processBarcode(barcode);
                    }, 1500);
                    
                } else {
                    const errorMsg = result.error || 'Failed to create account. Please try again.';
                    alert(errorMsg);
                }
                
            } catch (error) {
                console.error('Signup error:', error);
                
                let errorMsg = 'Network error. Please check your connection and try again.';
                
                // If it's a fetch error, provide more specific message
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMsg = 'Unable to connect to the server. Please check your internet connection and try again.';
                } else if (error instanceof SyntaxError) {
                    errorMsg = 'Server error. Please try again or contact an administrator if the problem persists.';
                }
                
                alert(errorMsg);
            } finally {
                // Re-enable buttons
                const submitBtn = document.querySelector('.btn-primary');
                const cancelBtn = document.querySelector('.btn-secondary');
                submitBtn.disabled = false;
                cancelBtn.disabled = false;
                submitBtn.textContent = 'Sign Up & Check In';
            }
        }

        // Handle Enter key in signup name field
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('signupName');
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitSignup();
                }
            });
        });

        // Handle visibility change to refocus input
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(() => {
                    document.getElementById('barcodeInput').focus();
                }, 100);
            }
        });
    </script>
</body>
</html>
